language: c

before_install:
  - sudo apt-get update
  - sudo apt-get install -q postgresql-server-dev-9.3 libcunit1-dev valgrind
  - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
  - sudo apt-get update -qq

install:
  - sudo apt-get install -qq g++-4.8
  - export CXX="g++-4.8"
  - sh .install-lazperf.sh
  - sh .install-libght.sh

addons:
  postgresql: "9.3" # for "installcheck"

script:
  - ./autogen.sh
  - ./configure CFLAGS="-Wall -O2 -g" --with-lazperf=/usr/local --with-libght=/usr/local
  - make
  - make check
# valgrind currently reports many problems with libght. So, for now, and
# until these problems are fixed, we rebuild pointcloud without libght
# for the remaining tests
  - make clean maintainer-clean
  - ./autogen.sh
  - ./configure CFLAGS="-Wall -O2 -g" --with-lazperf=/usr/local --without-libght
  - make
  - valgrind --leak-check=full --error-exitcode=1 lib/cunit/cu_tester
  - sudo make install
  - make installcheck || { cat pgsql/regression.diffs && false; }
  - cd tools/benchmark_compression && sh compression_benchmark.sh
